name: CD - Deploy to Render

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-backend:
    name: Deploy Backend to Render
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Trigger Render deployment
      uses: johnbeynon/render-deploy-action@v0.0.8
      with:
        service-id: ${{ secrets.RENDER_BACKEND_SERVICE_ID }}
        api-key: ${{ secrets.RENDER_API_KEY }}
    
    - name: Wait for deployment
      run: sleep 60
    
    - name: Health check
      run: |
        curl --retry 5 --retry-delay 10 --retry-all-errors \
          ${{ secrets.RENDER_BACKEND_URL }}/api/v1/health

  deploy-frontend:
    name: Deploy Frontend to Render
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: deploy-backend
    
    steps:
    - name: Trigger Render deployment
      uses: johnbeynon/render-deploy-action@v0.0.8
      with:
        service-id: ${{ secrets.RENDER_FRONTEND_SERVICE_ID }}
        api-key: ${{ secrets.RENDER_API_KEY }}
    
    - name: Wait for deployment
      run: sleep 60
    
    - name: Health check
      run: |
        curl --retry 5 --retry-delay 10 --retry-all-errors \
          ${{ secrets.RENDER_FRONTEND_URL }}

  notify:
    name: Notify deployment status
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()
    
    steps:
    - name: Deployment succeeded
      if: ${{ needs.deploy-backend.result == 'success' && needs.deploy-frontend.result == 'success' }}
      run: |
        echo "✅ Deployment successful"
        echo "Backend: ${{ secrets.RENDER_BACKEND_URL }}"
        echo "Frontend: ${{ secrets.RENDER_FRONTEND_URL }}"
    
    - name: Deployment failed
      if: ${{ needs.deploy-backend.result == 'failure' || needs.deploy-frontend.result == 'failure' }}
      run: |
        echo "❌ Deployment failed"
        exit 1
